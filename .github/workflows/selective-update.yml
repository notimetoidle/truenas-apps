name: Selectively pull apps from truenas/apps and run modifications

on:
  #schedule:
  #  - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  sync_and_patch:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    - name: Clone the target repository
      run: |
        git clone --depth 1 --filter=blob:none --sparse https://github.com/truenas/apps.git truenas-apps
        cd truenas-apps
        git sparse-checkout set path/to/subdir

    - name: Copy subdirectory into the current repository
      run: |
        rsync -av --delete target-repo/path/to/subdir/ local/path/to/subdir

    - name: Apply patches
      run: |
        git apply patches/*.patch || echo "No patches applied"

    - name: Commit changes if there are any
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git diff-index --quiet HEAD || git commit -m "Sync and patch subdirectory"

    - name: Push changes
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
